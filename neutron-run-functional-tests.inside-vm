#!/bin/sh

BASEDIR=/opt/stack

sudo mkdir -p $BASEDIR
sudo chmod a+rwx $BASEDIR

cd $BASEDIR
for repo in neutron devstack requirements; do
	git clone https://opendev.org/openstack/$repo
done

# TODO: remove when https://review.opendev.org/c/openstack/neutron/+/935024 merges
# Install ovn packages since we are not compiling it and functional tests depend on schemas
cd $BASEDIR/neutron
git fetch https://review.opendev.org/openstack/neutron refs/changes/24/935024/1 && git cherry-pick FETCH_HEAD

cd $BASEDIR/neutron
Q_BUILD_OVS_FROM_GIT=False ./tools/configure_for_func_testing.sh ../devstack -i

if [ -f /etc/redhat-release ]; then
  # from https://docs.fedoraproject.org/en-US/epel/getting-started/
  sudo dnf config-manager --set-enabled crb
	sudo dnf install -y https://dl.fedoraproject.org/pub/epel/epel{,-next}-release-latest-9.noarch.rpm

  sudo dnf install -y python-tox
else
  sudo apt-get install -y tox
fi
tox -e dsvm-functional
